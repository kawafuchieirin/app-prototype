services:
  # DynamoDB Local
  dynamodb:
    image: amazon/dynamodb-local:latest
    container_name: app-prototype-dynamodb
    ports:
      - "8000:8000"
    command: "-jar DynamoDBLocal.jar -sharedDb -dbPath /data"
    volumes:
      - dynamodb-data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8000 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5

  # DynamoDB テーブル初期化
  dynamodb-init:
    image: amazon/aws-cli:latest
    container_name: app-prototype-dynamodb-init
    depends_on:
      dynamodb:
        condition: service_healthy
    environment:
      AWS_ACCESS_KEY_ID: dummy
      AWS_SECRET_ACCESS_KEY: dummy
      AWS_DEFAULT_REGION: ap-northeast-1
    entrypoint: /bin/sh
    command:
      - -c
      - |
        aws dynamodb create-table \
          --table-name app-prototype-local \
          --attribute-definitions \
            AttributeName=PK,AttributeType=S \
            AttributeName=SK,AttributeType=S \
            AttributeName=GSI1PK,AttributeType=S \
            AttributeName=GSI1SK,AttributeType=S \
          --key-schema \
            AttributeName=PK,KeyType=HASH \
            AttributeName=SK,KeyType=RANGE \
          --global-secondary-indexes \
            '[{"IndexName":"GSI1","KeySchema":[{"AttributeName":"GSI1PK","KeyType":"HASH"},{"AttributeName":"GSI1SK","KeyType":"RANGE"}],"Projection":{"ProjectionType":"ALL"}}]' \
          --billing-mode PAY_PER_REQUEST \
          --endpoint-url http://dynamodb:8000 \
          2>/dev/null || echo "Table already exists"

  # Backend API
  backend:
    build:
      context: ..
      dockerfile: local/Dockerfile.backend
    container_name: app-prototype-backend
    ports:
      - "8080:8080"
    environment:
      DEBUG: "true"
      AWS_REGION: ap-northeast-1
      AWS_ACCESS_KEY_ID: dummy
      AWS_SECRET_ACCESS_KEY: dummy
      DYNAMODB_TABLE_NAME: app-prototype-local
      DYNAMODB_ENDPOINT_URL: http://dynamodb:8000
      ALLOWED_ORIGINS: '["http://localhost:5173","http://localhost:3000","http://frontend:5173"]'
    volumes:
      - ../backend/app:/app/app:ro
    depends_on:
      dynamodb-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Frontend
  frontend:
    build:
      context: ..
      dockerfile: local/Dockerfile.frontend
    container_name: app-prototype-frontend
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost:8080
    volumes:
      - ../frontend/src:/app/src:ro
      - ../frontend/public:/app/public:ro
    depends_on:
      backend:
        condition: service_healthy

volumes:
  dynamodb-data:
