name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: ap-northeast-1
  TF_VERSION: "1.7.0"

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        working-directory: infrastructure/terraform

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init -upgrade

      - name: Terraform Apply (ECR and other resources except Lambda)
        run: |
          # ECRリポジトリを先に作成
          terraform apply -target=aws_ecr_repository.api -target=aws_ecr_lifecycle_policy.api -auto-approve || true

          # Lambda以外のリソースを適用
          terraform apply \
            -target=aws_s3_bucket.frontend \
            -target=aws_s3_bucket_versioning.frontend \
            -target=aws_s3_bucket_public_access_block.frontend \
            -target=aws_cloudfront_origin_access_control.frontend \
            -target=aws_cloudfront_distribution.frontend \
            -target=aws_s3_bucket_policy.frontend \
            -target=aws_dynamodb_table.main \
            -target=aws_cognito_user_pool.main \
            -target=aws_cognito_user_pool_client.main \
            -target=aws_iam_role.lambda \
            -target=aws_iam_role_policy_attachment.lambda_basic \
            -target=aws_iam_role_policy.lambda_dynamodb \
            -target=aws_apigatewayv2_api.main \
            -target=aws_cloudwatch_log_group.api_gateway \
            -target=aws_apigatewayv2_stage.main \
            -target=aws_apigatewayv2_authorizer.cognito \
            -auto-approve || true

      - name: Get Terraform Outputs
        id: tf-outputs
        run: |
          echo "frontend_bucket=$(terraform output -raw frontend_bucket_name 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "cloudfront_id=$(terraform output -raw cloudfront_distribution_id 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "api_gateway_url=$(terraform output -raw api_gateway_url 2>/dev/null || echo '')" >> $GITHUB_OUTPUT
          echo "ecr_repository_url=$(terraform output -raw ecr_repository_url 2>/dev/null || echo '')" >> $GITHUB_OUTPUT

    outputs:
      frontend_bucket: ${{ steps.tf-outputs.outputs.frontend_bucket }}
      cloudfront_id: ${{ steps.tf-outputs.outputs.cloudfront_id }}
      api_gateway_url: ${{ steps.tf-outputs.outputs.api_gateway_url }}
      ecr_repository_url: ${{ steps.tf-outputs.outputs.ecr_repository_url }}

  deploy-backend:
    name: Deploy Backend
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker Image
        working-directory: backend
        env:
          ECR_REPOSITORY_URL: ${{ needs.deploy-infrastructure.outputs.ecr_repository_url }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          if [ -z "$ECR_REPOSITORY_URL" ]; then
            echo "ECR repository URL not available, skipping deployment"
            exit 0
          fi

          echo "Building Docker image..."
          docker build -t ${ECR_REPOSITORY_URL}:${IMAGE_TAG} -t ${ECR_REPOSITORY_URL}:latest .

          echo "Pushing Docker image..."
          docker push ${ECR_REPOSITORY_URL}:${IMAGE_TAG}
          docker push ${ECR_REPOSITORY_URL}:latest

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Deploy Lambda with Terraform
        working-directory: infrastructure/terraform
        env:
          ECR_REPOSITORY_URL: ${{ needs.deploy-infrastructure.outputs.ecr_repository_url }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          terraform init -upgrade

          # Lambda関数とAPI Gateway統合を作成/更新
          terraform apply -auto-approve

      - name: Update Lambda to use new image
        env:
          ECR_REPOSITORY_URL: ${{ needs.deploy-infrastructure.outputs.ecr_repository_url }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          FUNCTION_NAME="app-prototype-api-dev"

          echo "Updating Lambda function with new image..."
          aws lambda update-function-code \
            --function-name "$FUNCTION_NAME" \
            --image-uri "${ECR_REPOSITORY_URL}:${IMAGE_TAG}"

          echo "Waiting for Lambda update to complete..."
          aws lambda wait function-updated \
            --function-name "$FUNCTION_NAME"

          echo "Lambda function updated successfully"

  deploy-frontend:
    name: Deploy Frontend
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          VITE_API_URL: ${{ needs.deploy-infrastructure.outputs.api_gateway_url }}

      - name: Deploy to S3
        run: |
          BUCKET="${{ needs.deploy-infrastructure.outputs.frontend_bucket }}"
          if [ -z "$BUCKET" ]; then
            echo "S3 bucket not available, skipping deployment"
            exit 0
          fi
          aws s3 sync dist/ s3://$BUCKET --delete

      - name: Invalidate CloudFront Cache
        run: |
          DIST_ID="${{ needs.deploy-infrastructure.outputs.cloudfront_id }}"
          if [ -z "$DIST_ID" ]; then
            echo "CloudFront distribution not available, skipping invalidation"
            exit 0
          fi
          aws cloudfront create-invalidation \
            --distribution-id $DIST_ID \
            --paths "/*"
